services:
    # JaCoCo agent downloader service
    jacoco-downloader:
        image: curlimages/curl:8.13.0
        container_name: jacoco-setup
        user: root  # Run as root to ensure write permissions
        command: sh -c "mkdir -p /jacoco-data && curl -L -o /jacoco-data/jacocoagent.jar https://repo1.maven.org/maven2/org/jacoco/org.jacoco.agent/0.8.8/org.jacoco.agent-0.8.8-runtime.jar && chmod -R 777 /jacoco-data"
        volumes:
            - jacoco-data:/jacoco-data
        healthcheck:
            test: ["CMD", "test", "-f", "/jacoco-data/jacocoagent.jar"]
            interval: 1s
            timeout: 3s
            retries: 5
        networks:
            - stack
    jahia:
        image: '${JAHIA_IMAGE}'
        container_name: jahia
        depends_on:
            - jacoco-downloader
        volumes:
            - jacoco-data:/jacoco-data
        deploy:
          resources:
            limits:
              memory: 4gb
        environment:
            JAHIA_LICENSE: ${JAHIA_LICENSE}
            SUPER_USER_PASSWORD: ${SUPER_USER_PASSWORD}
            PROCESSING_SERVER: 'true'
            MAX_RAM_PERCENTAGE: 80
            JAHIA_PROPERTIES: ${JAHIA_PROPERTIES}
            CATALINA_OPTS: ${CATALINA_OPTS}
            RESTORE_MODULE_STATES: 'false'
            NEXUS_USERNAME: ${NEXUS_USERNAME}
            NEXUS_PASSWORD: ${NEXUS_PASSWORD}
            TZ: ${TIMEZONE}
            JPDA: 'true'
            JAVA_OPTS: '-javaagent:/jacoco-data/jacocoagent.jar=destfile=/jacoco-data/jacoco-cypress.exec,append=true,output=file,includes=org.jahia.modules.*'

        ports:
            - '8000:8000'
            - '8080:8080'
            - '8101:8101'
        extra_hosts:
            - jahia:127.0.0.1
        networks:
            - stack
    # Cypress container
    cypress:
        profiles: ["test"]
        image: '${TESTS_IMAGE}'
        container_name: cypress
        deploy:
          resources:
            limits:
              memory: 4gb
        depends_on:
            - jahia
        environment:
            JAHIA_LICENSE: ${JAHIA_LICENSE}
            MANIFEST: ${MANIFEST}
            JAHIA_USERNAME: ${JAHIA_USERNAME}
            JAHIA_PASSWORD: ${JAHIA_PASSWORD}
            JAHIA_URL: ${JAHIA_URL}
            JAHIA_HOST: ${JAHIA_HOST}
            JAHIA_PORT: ${JAHIA_PORT}
            NEXUS_USERNAME: ${NEXUS_USERNAME}
            NEXUS_PASSWORD: ${NEXUS_PASSWORD}
            SUPER_USER_PASSWORD: ${SUPER_USER_PASSWORD}
            SKIP_TESTS: ${SKIP_TESTS:-false}
            TESTS_PROFILE: ${TESTS_PROFILE:-}
        networks:
            - stack
networks:
    stack:
volumes:
    jacoco-data:
